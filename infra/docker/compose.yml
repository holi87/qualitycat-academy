name: academy-prod

services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    env_file:
      - ./env.example
    volumes:
      - academy_db_data:/var/lib/postgresql/data
    ports:
      - "5532:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 10

  api-migrate:
    image: academy-api:migrate
    build:
      context: ../../apps/api
      dockerfile: Dockerfile
      target: deps
    restart: "no"
    env_file:
      - ./env.example
    command: sh -c "npm run db:migrate"
    depends_on:
      db:
        condition: service_healthy

  api-bootstrap:
    image: academy-api:bootstrap
    build:
      context: ../../apps/api
      dockerfile: Dockerfile
      target: deps
    restart: "no"
    env_file:
      - ./env.example
    command: sh -c "npm run db:bootstrap"
    depends_on:
      db:
        condition: service_healthy
      api-migrate:
        condition: service_completed_successfully

  api:
    image: academy-api:prod
    build:
      context: ../../apps/api
      dockerfile: Dockerfile
      target: runtime
    restart: unless-stopped
    env_file:
      - ./env.example
    environment:
      NODE_ENV: production
      PORT: "8081"
    depends_on:
      db:
        condition: service_healthy
      api-migrate:
        condition: service_completed_successfully
      api-bootstrap:
        condition: service_completed_successfully
    networks:
      - default
      - proxy
    ports:
      - "8281:8081"
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.qca-api.rule=Host(`academy.qualitycat.com.pl`) && PathPrefix(`/api`)
      - traefik.http.routers.qca-api.entrypoints=web
      - traefik.http.routers.qca-api.priority=100
      - traefik.http.routers.qca-api.middlewares=qca-api-strip
      - traefik.http.middlewares.qca-api-strip.stripprefix.prefixes=/api
      - traefik.http.services.qca-api.loadbalancer.server.port=8081
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1:8081/health >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  web:
    image: academy-web:prod
    build:
      context: ../../apps/web
      dockerfile: Dockerfile
      target: runtime
      args:
        VITE_API_URL: ${VITE_API_URL:-/api}
        VITE_BUGS: ${VITE_BUGS:-off}
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    networks:
      - default
      - proxy
    ports:
      - "8280:80"
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.qca-web.rule=Host(`academy.qualitycat.com.pl`)
      - traefik.http.routers.qca-web.entrypoints=web
      - traefik.http.routers.qca-web.priority=10
      - traefik.http.services.qca-web.loadbalancer.server.port=80
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1 >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

networks:
  proxy:
    external: true

volumes:
  academy_db_data:
