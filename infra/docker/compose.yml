services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    env_file:
      - ./env.example
    ports:
      - "5532:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 10

  api:
    image: academy-api:prod
    build:
      context: ../../apps/api
      dockerfile: Dockerfile
      target: runtime
    restart: unless-stopped
    env_file:
      - ./env.example
    environment:
      NODE_ENV: production
      PORT: "8081"
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8281:8081"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1:8081/health >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  web:
    image: academy-web:prod
    build:
      context: ../../apps/web
      dockerfile: Dockerfile
      target: runtime
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8281}
        VITE_BUGS: ${VITE_BUGS:-off}
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    networks:
      - default
      - proxy
    ports:
      - "8280:80"
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.academy.rule=Host(`academy.qualitycat.pl`)
      - traefik.http.routers.academy.entrypoints=web
      - traefik.http.services.academy.loadbalancer.server.port=80
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1 >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

networks:
  proxy:
    external: true
